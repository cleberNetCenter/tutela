name: Generate Sitemap

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate sitemap
        run: |
          rm -f public/sitemap.xml

          echo '<?xml version="1.0" encoding="UTF-8"?>' >> public/sitemap.xml
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> public/sitemap.xml

          FILES=$(git ls-files | grep '^public/.*\.html$')

          for file in $FILES; do

            if [[ "$file" == public/partials/* ]]; then
              continue
            fi

            clean=${file#public/}
            url=${clean%index.html}
            url=${url%.html}

            priority="0.8"
            changefreq="monthly"

            if [[ "$url" == "" ]]; then
              priority="1.0"
              changefreq="weekly"
              final_url="https://tuteladigital.com.br/"
            else
              final_url="https://tuteladigital.com.br/$url"
            fi

            if [[ "$url" == insights/ ]]; then
              priority="0.8"
              changefreq="weekly"
            elif [[ "$url" == insights/* ]]; then
              priority="0.7"
              changefreq="monthly"
            elif [[ "$url" == legal/* ]]; then
              priority="0.6"
              changefreq="yearly"
            fi

            lastmod=$(git log -1 --format="%Y-%m-%d" -- "$file")

            echo "  <url>" >> public/sitemap.xml
            echo "    <loc>$final_url</loc>" >> public/sitemap.xml
            echo "    <lastmod>$lastmod</lastmod>" >> public/sitemap.xml
            echo "    <changefreq>$changefreq</changefreq>" >> public/sitemap.xml
            echo "    <priority>$priority</priority>" >> public/sitemap.xml
            echo "  </url>" >> public/sitemap.xml

          done

          echo '</urlset>' >> public/sitemap.xml

      - name: Commit sitemap
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add public/sitemap.xml
          git commit -m "Auto update sitemap" || echo "No changes"
          git push